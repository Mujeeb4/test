version: 2.1

executors:
  python-executor:
    docker:
      - image: circleci/python:3.8
    working_directory: ~/repo

jobs:
  test:
    executor: python-executor
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            sudo apt-get update
            sudo apt-get install -y unzip wget xvfb chromium-browser
            pip install selenium
      - run:
          name: Run the test with screen recording
          command: |
            Xvfb :99 -screen 0 1280x1024x16 & # Start virtual display
            export DISPLAY=:99
            wget https://chromedriver.storage.googleapis.com/96.0.4664.45/chromedriver_linux64.zip
            unzip chromedriver_linux64.zip
            mv chromedriver /usr/local/bin/
            python test_script.py
            # Optionally record the session
            ffmpeg -video_size 1280x1024 -framerate 25 -f x11grab -i :99.0 screen_recording.mp4

  release:
    executor: python-executor
    steps:
      - checkout
      - run: git fetch --tags
      - run:
          name: Release
          command: sbt clean compile ci-release

workflows:
  build-and-release:
    jobs:
      - test:
          filters:
            branches:
              ignore: /.*/  # Ignore all branches
            tags:
              only: /^v.*/  # Only trigger on tags that start with 'v'
      - release:
          requires:
            - test
          filters:
            tags:
              only: /^v.*/  # Only trigger the release job on tags starting with 'v'
